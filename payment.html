<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment - Nebula Store</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .payment-box, .method-box, .upload-box {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 2rem;
      margin: 2rem auto;
      max-width: 600px;
      box-shadow: 0 0 20px rgba(0,240,255,0.3);
    }
    .method-box label {
      display: block;
      margin: 0.5rem 0;
      cursor: pointer;
    }
    #qrisImg, #rekeningInfo {
      display: none;
      margin-top: 1rem;
    }
    #qrisImg img {
      width: 200px;
      border-radius: 10px;
    }
    input[type=file] {
      margin-top: 0.5rem;
    }
    button[type=submit] {
      margin-top: 1.5rem;
      width: 100%;
      padding: 0.8rem;
      border: none;
      border-radius: 10px;
      background: #00f0ff;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    button[type=submit]:hover {
      background: #00c8d6;
    }
  </style>
</head>
<body>
  <div class="nebula-bg"></div>

  <header>
    <nav>
      <div class="logo">Nebula Store</div>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="produk.html">Produk</a></li>
        <li><a href="bestseller.html">Best Seller</a></li>
        <li><a href="flashsale.html">Flash Sale</a></li>
        <li><a href="blog.html">Blog</a></li>
        <li><a href="kontak.html">Kontak</a></li>
      </ul>
      <div class="music-toggle" onclick="toggleMusic()">üéµ</div>
    </nav>
  </header>

  <main>
    <section class="hero">
      <h1>Pembayaran</h1>
    </section>

    <!-- Pilih Produk -->
    <div class="payment-box">
      <h2>Pilih Produk</h2>
      <select id="productSelect" class="u-full-width">
        <option value="" disabled selected>-- Pilih Produk --</option>
      </select>
      <p>Harga: <strong id="hargaTxt">-</strong></p>
    </div>

    <!-- Metode Pembayaran -->
    <div class="method-box">
      <h2>Metode Pembayaran</h2>
      <label><input type="radio" name="metode" value="qris" onchange="tampilkanBayar()"> QRIS</label>
      <label><input type="radio" name="metode" value="dana" onchange="tampilkanBayar()"> Dana</label>
      <label><input type="radio" name="metode" value="gopay" onchange="tampilkanBayar()"> GoPay</label>
      <label><input type="radio" name="metode" value="ovo" onchange="tampilkanBayar()"> OVO</label>

      <div id="qrisImg">
        <p>Scan kode QRIS berikut:</p>
        <img src="assets/images/qris.jpg" alt="QRIS">
      </div>
      <div id="rekeningInfo"></div>
    </div>

    <!-- Form Pembayaran -->
    <div class="upload-box">
      <h2>Data Pembayaran</h2>
      <form id="formPayment" onsubmit="handleBayar(event)">
        <label>Atas Nama Pengirim</label>
        <input type="text" id="namaPengirim" required />

        <label>Nomor WhatsApp</label>
        <input type="tel" id="waPengirim" required />

        <label>Username Telegram</label>
        <input type="text" id="telePengirim" required />

        <label>Bukti Transfer (gambar)</label>
        <input type="file" id="buktiTF" accept="image/*" required />

        <button type="submit">Kirim & Buat Struk</button>
        <p id="statusBayar"></p>
      </form>
    </div>
  </main>

  <footer>
    <div class="social-icons">
      <a href="https://wa.me/6281234567890" target="_blank">üì≤</a>
      <a href="https://t.me/username" target="_blank">‚úàÔ∏è</a>
      <a href="https://tiktok.com/@resellergaming" target="_blank">üéµ</a>
    </div>
    <p>&copy; 2025 Reseller Gaming. All rights reserved.</p>
  </footer>

  <audio id="bgMusic" loop>
    <source src="assets/music/nebula.mp3" type="audio/mp3" />
  </audio>

  <script src="js/main.js"></script>
  <script>
    // Isi pilihan produk + otomatis pilih dari parameter URL
    const productSelect = document.getElementById("productSelect");
    const hargaTxt = document.getElementById("hargaTxt");

    fetch("data/products.json")
      .then(r => r.json())
      .then(data => {
        const urlParams = new URLSearchParams(location.search);
        const prodParam = urlParams.get("product");
        const priceParam = urlParams.get("price");

        data.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.price;
          opt.textContent = p.name;
          if (p.name === prodParam) opt.selected = true;
          productSelect.appendChild(opt);
        });

        if (prodParam && priceParam) {
          hargaTxt.textContent = `Rp${Number(priceParam).toLocaleString()}`;
        }
      });

    productSelect.onchange = () => {
      const harga = Number(productSelect.value);
      hargaTxt.textContent = `Rp${harga.toLocaleString()}`;
    };

    // Tampilkan QRIS atau nomor e-wallet
    const dataRek = {
      dana: { nomor: "0857-1234-5678", atas: "A/N Reseller Gaming Dana" },
      gopay: { nomor: "0857-1234-5679", atas: "A/N Reseller Gaming GoPay" },
      ovo: { nomor: "0857-1234-5680", atas: "A/N Reseller Gaming OVO" }
    };

    function tampilkanBayar() {
      const metode = document.querySelector("[name=metode]:checked").value;
      const qrisImg = document.getElementById("qrisImg");
      const rekInfo = document.getElementById("rekeningInfo");

      qrisImg.style.display = "none";
      rekInfo.style.display = "none";

      if (metode === "qris") {
        qrisImg.style.display = "block";
      } else {
        const rek = dataRek[metode];
        rekInfo.innerHTML = `<p>Nomor: <strong>${rek.nomor}</strong><br>${rek.atas}</p>`;
        rekInfo.style.display = "block";
      }
    }

    // Handle submit pembayaran
    async function handleBayar(e) {
      e.preventDefault();
      const status = document.getElementById("statusBayar");

      const produk = productSelect.options[productSelect.selectedIndex].text;
      const harga = Number(productSelect.value);
      const metode = document.querySelector("[name=metode]:checked")?.value;
      const nama = document.getElementById("namaPengirim").value;
      const wa = document.getElementById("waPengirim").value;
      const tele = document.getElementById("telePengirim").value;
      const bukti = document.getElementById("buktiTF").files[0];

      if (!metode) { status.textContent = "Pilih metode pembayaran!"; return; }
      if (!bukti) { status.textContent = "Upload bukti transfer!"; return; }

      // Generate ID struk
      const idStruk = "RESMING-" + Math.floor(10000000 + Math.random() * 90000000);

      // Baca gambar sebagai base64
      const reader = new FileReader();
      reader.onload = async function () {
        const base64 = reader.result.split(",")[1];

        // Kirim ke Telegram Bot
        const botToken = "GANTI_BOT_TOKEN";
        const chatId = "GANTI_CHAT_ID";
        const caption = `üìÑ Struk Pembayaran\n\nID: ${idStruk}\nProduk: ${produk}\nHarga: Rp${harga.toLocaleString()}\nMetode: ${metode.toUpperCase()}\nNama: ${nama}\nWA: ${wa}\nTele: @${tele}`;

        const formData = new FormData();
        formData.append("chat_id", chatId);
        formData.append("caption", caption);
        formData.append("photo", `data:image/jpeg;base64,${base64}`);

        try {
          const res = await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
            method: "POST",
            body: formData
          });
          const data = await res.json();
          if (data.ok) {
            status.innerHTML = `‚úÖ Pembayaran terkirim! ID Struk: <strong>${idStruk}</strong>`;
            document.getElementById("formPayment").reset();
          } else {
            status.textContent = "‚ùå Gagal kirim ke Telegram.";
          }
        } catch (err) {
          status.textContent = "‚ùå Error jaringan.";
          console.error(err);
        }
      };
      reader.readAsDataURL(bukti);
    }
  </script>
</body>
  </html>
